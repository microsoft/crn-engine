# Release pipeline

pr:
  branches:
    include:
    - '*'

pool:
  vmImage: 'windows-2019'
  demands:
  - msbuild
  - visualstudio
  timeoutInMinutes: 300

variables:
  BuildPlatform: 'x64'
  BuildConfiguration: 'release'

steps:
- script: 'dotnet tool restore'
  displayName: 'dotnet tool restore'

- task: DotNetCoreCLI@2
  displayName: 'dotnet restore'
  inputs:
    command: restore
    projects: '**/*.sln'

# Oslo
- task: VSBuild@1
  displayName: 'Build Oslo/Oslo.FSharp.sln'
  inputs:
    solution: Oslo/Oslo.FSharp.sln
    vsVersion: 16.0
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: Oslo/Oslo.FSharp/bin/Release/netstandard2.0
#     Contents: '**\*'
#     TargetFolder: 'Analysis/Oslo/Oslo.FSharp'

# CRN CLI
- task: VSBuild@1
  displayName: 'Build CRNEngine/CRNEngineCli.sln'
  inputs:
    solution: CRNEngine/CRNEngineCli.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: CRNEngine/CliCRN/bin/x64/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/CRNEngine/CliCRN'

# CRN Server
- task: VSBuild@1
  displayName: 'Build CRNEngine/CRNEngineServer.sln'
  inputs:
    solution: CRNEngine/CRNEngineServer.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: CRNEngine/CRNEngineWebServer/bin/x64/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/CRNEngine/CRNEngineWebServer'

# CRN HTML
- task: VSBuild@1
  displayName: 'Build CRNEngine/CRNEngineHTML.sln'
  inputs:
    solution: CRNEngine/CRNEngineHTML.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: CRNEngine/HTML5CRN/bin/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/CRNEngine/HTML5CRN'

# GEC CLI
- task: VSBuild@1
  displayName: 'Build ClassicGEC/ClassicGECCli.sln'
  inputs:
    solution: ClassicGEC/ClassicGECCli.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicGEC/ClassicGECCLI/bin/x64/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicGEC/ClassicGECCLI'

# GEC Server
- task: VSBuild@1
  displayName: 'Build ClassicGEC/ClassicGECServer.sln'
  inputs:
    solution: ClassicGEC/ClassicGECServer.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicGEC/ClassicGECWebServer/bin/x64/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicGEC/ClassicGECWebServer'

# GEC HTML
- task: VSBuild@1
  displayName: 'Build ClassicGEC/ClassicGECHTML.sln'
  inputs:
    solution: ClassicGEC/ClassicGECHTML.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicGEC/ClassicGECHTML5/bin/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicGEC/ClassicGECHTML5'

# DSD CLI
- task: VSBuild@1
  displayName: 'Build ClassicDSD/ClassicDSD.sln'
  inputs:
    solution: ClassicDSD/ClassicDSD.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicDSD/ClassicDSDCLI/bin/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicDSD/ClassicDSDCLI'

# DSD Server
- task: VSBuild@1
  displayName: 'Build ClassicDSD/ClassicDSDServer.sln'
  inputs:
    solution: ClassicDSD/ClassicDSDServer.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicDSD/ClassicDSDServer/bin/x64/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicDSD/ClassicDSDServer'

# DSD HTML
- task: VSBuild@1
  displayName: 'Build ClassicDSD/ClassicDSDHTML5.sln'
  inputs:
    solution: ClassicDSD/ClassicDSDHTML5.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

# - task: CopyFiles@2
#   displayName: 'Copy bin to analysis folder'
#   inputs:
#     SourceFolder: ClassicDSD/ClassicDSDHTML5/bin/Release/netcoreapp3.1
#     Contents: '**\*'
#     TargetFolder: 'Analysis/ClassicDSD/ClassicDSDHTML5'

- task: CredScan@3
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))

- task: Semmle@1
  inputs:
    sourceCodeDirectory: '$(Build.SourcesDirectory)'
    language: 'tsandjs'
    includeNodeModules: false
    querySuite: 'Recommended'
    timeout: '1800'
    ram: '16384'
    addProjectDirToScanningExclusionList: true

- task: ComponentGovernanceComponentDetection@0
  condition: succeeded()
  inputs:
    scanType: 'Register'
    verbosity: 'Normal'
    alertWarningLevel: 'High'
    failOnAlert: true
    failOnStderr: true

- task: PostAnalysis@1
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: 'Post Analysis'
  inputs:
    CredScan: true
    Semmle: true