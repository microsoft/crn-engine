# Release pipeline

pool:
  vmImage: 'windows-2019'
  demands:
  - msbuild
  - visualstudio

  timeoutInMinutes: 300

variables:
  BuildPlatform: 'x64'
  BuildConfiguration: 'release'

steps:
- script: 'dotnet tool restore'
  displayName: 'dotnet tool restore'

- task: DotNetCoreCLI@2
  displayName: 'dotnet restore: Classic DSD Server'
  inputs:
    command: restore
    projects: ClassicDSD/ClassicDSDServer.sln

- task: VSBuild@1
  displayName: 'Build solution ClassicDSDServer'
  inputs:
    solution: ClassicDSD/ClassicDSDServer.sln
    vsVersion: 16.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    restoreNugetPackages: true

- task: BinSkim@4
  inputs:
    InputType: 'Basic'
    Function: 'analyze'
    TargetPattern: 'guardianGlob'
    AnalyzeTargetGlob: 'ClassicDSD/ClassicDSDServer/bin/x64/Release/netcoreapp3.1/*'

- task: CredScan@3
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))

- task: Semmle@1
  inputs:
    sourceCodeDirectory: '$(Build.SourcesDirectory)'
    language: 'tsandjs'
    includeNodeModules: false
    querySuite: 'Recommended'
    timeout: '1800'
    ram: '16384'
    addProjectDirToScanningExclusionList: true

- task: ComponentGovernanceComponentDetection@0
  condition: succeeded()
  inputs:
    scanType: 'Register'
    verbosity: 'Normal'
    alertWarningLevel: 'High'
    failOnAlert: true
    failOnStderr: true

- task: PostAnalysis@1
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: 'Post Analysis'
  inputs:
    BinSkim: true
    CredScan: true
    Semmle: true